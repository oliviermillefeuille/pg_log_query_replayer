# PG Log Query Replayer

This tool replays SELECT queries that have been logged by a PostgreSQL logging system instance on a specific PG instance.

## Run the tool

```bash
ruby log_query_replayer.rb [mandatory parameters] [options]
```

Mandatory parameters
```text
    --logfile LOGFILE
    --pghost PGHOST
    --pgdatabase PGDATABASE
    --pguser PGUSER
    --pgport PGPORT
```

Options
```text
    --pgpassword <PGPASSWORD>
    --skiplines Number of lines to skip from the beginning of the file
    --maxlines Maximum line number at which the replay stops
```

## Output

The results of will be printed on STDOUT. The output will consist of three sections, with the last two sections being displayed only if the tool is able to read the entire log file. 

All sections of the output data will be in CSV format for easy capture, and each section will begin with a header. The first section will contain information about the replayed queries and their statistics. The second section will display the top 100 queries sorted by their total cost, with the queries with the highest total cost on top. The third section will show the top 100 queries sorted by their count, with the queries that occur most frequently on top.

In this version, these 4 fields from the query plan are being captured:
```Actual Total Time, Total Cost, Shared Hit Blocks, Shared Read Blocks```

See an example below:
```
# REPLAYING LOG FILE 
elapsed_in_secs,execution_number,line_number,fingerprint,count,cost,avg_cost,time,avg_time,shared_hit_blocks,avg_shared_hit_blocks,shared_read_blocks,avg_shared_read_blocks
1.729327,1,1,5f1ab0fa5dd08863,1,0.049,0.049,8.44,8.44,4.0,4.0,0.0,0.0
2.091389,2,4,232416985003ca0b,1,0.048,0.048,8.44,8.44,7.0,7.0,0.0,0.0
2.227272,3,12,595e9ed2fb1128af,1,0.003,0.003,8.16,8.16,2.0,2.0,0.0,0.0
2.38604,4,15,595e9ed2fb1128af,2,0.006,0.0045000000000000005,8.16,8.16,2.0,2.0,0.0,0.0
2.469703,5,33,98ee9ba3a3c76056,1,0.393,0.393,70.18,70.18,16.0,16.0,0.0,0.0
2.563886,6,53,e78fe2c08de5f079,1,0.031,0.031,78.15,78.15,22.0,22.0,0.0,0.0
2.623094,7,62,595e9ed2fb1128af,3,0.008,0.005666666666666667,8.16,8.16,2.0,2.0,0.0,0.0
2.679911,8,70,595e9ed2fb1128af,4,0.007,0.006,8.16,8.16,2.0,2.0,0.0,0.0
2.730294,9,73,5f1ab0fa5dd08863,2,0.039,0.044,8.44,8.44,4.0,4.0,0.0,0.0
2.778994,10,91,232416985003ca0b,2,0.018,0.033,8.44,8.44,4.0,5.5,0.0,0.0
2.872408,11,101,e78fe2c08de5f079,2,0.028,0.0295,78.15,78.15,22.0,22.0,0.0,0.0
2.93116,12,115,595e9ed2fb1128af,5,0.006,0.006,8.16,8.16,2.0,2.0,0.0,0.0
2.980132,13,121,5f1ab0fa5dd08863,3,0.02,0.036,8.44,8.44,4.0,4.0,0.0,0.0
3.027672,14,130,232416985003ca0b,3,0.015,0.027,8.44,8.44,4.0,5.0,0.0,0.0
```

## Example

In the following PG log file (all private information have been deleted but its structure remains the same)
The replay will execute the query found on lines: 1, 4, 12, 15, 28, 31 and 36. Note that the query on line #28 expands to line #30.

```
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.028 ms  execute <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.052 ms  parse <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.062 ms  bind <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.024 ms  execute <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.020 ms  statement: BEGIN ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.057 ms  parse <unnamed>: UPDATE ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.064 ms  bind <unnamed>: UPDATE ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.171 ms  execute <unnamed>: UPDATE ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 2.553 ms  statement: COMMIT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.137 ms  parse <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.105 ms  bind <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.047 ms  execute <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.111 ms  parse <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.093 ms  bind <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.419 ms  execute <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.039 ms  statement: ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.065 ms  parse <unnamed>: UPDATE ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.055 ms  bind <unnamed>: UPDATE ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.084 ms  execute <unnamed>: UPDATE ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 1.649 ms  statement: COMMIT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.027 ms  statement: SET ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.080 ms  parse <unnamed>: SELECT ...
	FROM ...
	WHERE ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.166 ms  bind <unnamed>: SELECT ...
	FROM ...
	WHERE ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.040 ms  execute <unnamed>: SELECT ...
	FROM ...
	WHERE ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 1.736 ms  execute <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.059 ms  statement: select 1
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.074 ms  parse <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.069 ms  bind <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.036 ms  statement: SET ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 1.736 ms  execute <unnamed>: SELECT ...
2023-04-21 11:54:56 UTC:192.168.0.10(39200):LOG:  duration: 0.019 ms  statement: SET ...
```
